# Zephyr Shell Loader

A fast, dependency-aware shell module loader written in Odin that brings order to your shell configuration.

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Platform](https://img.shields.io/badge/platform-macOS%20%7C%20Linux-lightgrey)](https://github.com/xDarkicex/zephyr)

## Overview

Zephyr is a shell module loader system that manages dependencies, load order, and configuration for shell modules (primarily ZSH). It reads TOML manifests, resolves dependencies using topological sorting, and emits shell code for sourcing modules in the correct order.

**Why Zephyr?**
- üöÄ **Fast**: Written in Odin for minimal startup overhead
- üîó **Smart Dependencies**: Automatic resolution with cycle detection
- üì¶ **Modular**: Organize your shell config into reusable modules
- üéØ **Platform Aware**: Load modules only where they're supported
- üõ†Ô∏è **Developer Friendly**: Simple TOML configuration

## Table of Contents

- [Installation](#installation)
- [Quick Start](#quick-start)
- [Commands](#commands)
- [Module Development](#module-development)
- [Configuration Reference](#configuration-reference)
- [Examples](#examples)
- [Troubleshooting](#troubleshooting)
- [Contributing](#contributing)

## Installation

### Prerequisites

- [Odin compiler](https://odin-lang.org/docs/install/) (for building from source)
- ZSH shell
- macOS or Linux

### Install from Source

```bash
# Clone the repository
git clone https://github.com/xDarkicex/zephyr.git
cd zephyr

# Build and install
./install.sh
```

This will:
1. Build the `zephyr` binary
2. Install it to `$HOME/.zsh/bin/zephyr`
3. Create the modules directory at `$HOME/.zsh/modules`
4. Set up a basic `core` module

### Shell Integration

Add this line to your `.zshrc`:

```bash
# Load Zephyr modules
eval "$($HOME/.zsh/bin/zephyr load)"
```

Or if you prefer to add the bin directory to your PATH:

```bash
export PATH="$HOME/.zsh/bin:$PATH"
eval "$(zephyr load)"
```

### Verify Installation

```bash
# Check if zephyr is working
zephyr list

# Should show something like:
# Resolved load order:
#   1. core [priority: 10]
```

## Quick Start

### 1. Create Your First Module

```bash
# Create a new module for your aliases
zephyr init my-aliases
```

This creates:
```
$HOME/.zsh/modules/my-aliases/
‚îú‚îÄ‚îÄ module.toml
‚îú‚îÄ‚îÄ aliases.zsh
‚îî‚îÄ‚îÄ functions.zsh
```

### 2. Add Some Content

Edit `$HOME/.zsh/modules/my-aliases/aliases.zsh`:

```bash
# Git aliases
alias gs='git status'
alias ga='git add'
alias gc='git commit'
alias gp='git push'

# Directory navigation
alias ll='ls -la'
alias la='ls -A'
alias l='ls -CF'
```

### 3. Reload Your Shell

```bash
# Reload your shell configuration
exec zsh
```

Your aliases are now available! Zephyr automatically discovered and loaded your module.

## Commands

### `zephyr load` (default)

Generates shell code for loading all discovered modules in dependency order.

```bash
# Generate and execute module loading code
eval "$(zephyr load)"

# Or just see what would be loaded
zephyr load
```

**Output example:**
```bash
# Generated by Zephyr Shell Loader
# Generated: 2024-01-15 10:30:45

# === Module: core v1.0.0 ===
export ZSH_MODULE_CORE_THEME="default"
source "$HOME/.zsh/modules/core/exports.zsh"

# === Module: my-aliases v1.0.0 ===
source "$HOME/.zsh/modules/my-aliases/aliases.zsh"
```

### `zephyr list`

Shows all discovered modules and their load order.

```bash
zephyr list
```

**Output example:**
```
Resolved load order:

  1. core [priority: 10]
     ‚îî‚îÄ depends on: []

  2. colors [priority: 20]
     ‚îî‚îÄ depends on: ["core"]

  3. git-helpers [priority: 50]
     ‚îî‚îÄ depends on: ["core", "colors"]

  4. my-aliases [priority: 100]
     ‚îî‚îÄ depends on: []
```

### `zephyr validate`

Validates all module manifests for syntax errors and dependency issues.

```bash
zephyr validate
```

**Output examples:**
```bash
# Success
‚úì All modules validated successfully

# With errors
‚úó Validation failed:
  - git-helpers/module.toml: Missing required dependency 'colors'
  - my-module/module.toml: Invalid TOML syntax at line 5
```

### `zephyr init <name>`

Creates a new module skeleton with boilerplate files.

```bash
zephyr init my-new-module
```

**Creates:**
```
$HOME/.zsh/modules/my-new-module/
‚îú‚îÄ‚îÄ module.toml          # Module manifest
‚îú‚îÄ‚îÄ init.zsh            # Main initialization file
‚îú‚îÄ‚îÄ aliases.zsh         # Aliases (empty)
‚îú‚îÄ‚îÄ functions.zsh       # Functions (empty)
‚îî‚îÄ‚îÄ README.md           # Module documentation
```

## Module Development

### Basic Module Structure

A minimal module needs only two files:

```
my-module/
‚îú‚îÄ‚îÄ module.toml         # Required: module manifest
‚îî‚îÄ‚îÄ init.zsh           # Required: at least one shell file
```

### Module Manifest (`module.toml`)

#### Minimal Example

```toml
[module]
name = "my-module"
version = "1.0.0"

[load]
files = ["init.zsh"]
```

#### Complete Example

```toml
[module]
name = "git-helpers"
version = "1.2.0"
description = "Git utility functions and aliases"
author = "John Doe <john@example.com>"
license = "MIT"

[dependencies]
required = ["core", "colors"]
optional = ["fzf-integration"]

[platforms]
os = ["linux", "darwin"]
arch = ["x86_64", "arm64"]
shell = "zsh"
min_version = "5.8"

[load]
priority = 50
files = ["git-aliases.zsh", "git-functions.zsh"]

[hooks]
pre_load = "git_check_version"
post_load = "git_setup_completion"

[settings]
default_branch = "main"
auto_fetch = "true"
pager = "less -R"
```

### Shell Files

Shell files contain your actual ZSH code:

**aliases.zsh:**
```bash
# Git shortcuts
alias gs='git status'
alias gd='git diff'
alias gl='git log --oneline'

# Directory shortcuts
alias ..='cd ..'
alias ...='cd ../..'
```

**functions.zsh:**
```bash
# Create and enter directory
mkcd() {
    mkdir -p "$1" && cd "$1"
}

# Git commit with message
gcm() {
    git commit -m "$1"
}
```

### Using Dependencies

Modules can depend on other modules:

```toml
[dependencies]
required = ["core"]        # Must be loaded first
optional = ["colors"]      # Load if available
```

**In your shell code:**
```bash
# Check if optional dependency is loaded
if [[ -n "$ZSH_MODULE_COLORS_LOADED" ]]; then
    # Use colors module functionality
    echo "${GREEN}Git helpers loaded!${RESET}"
else
    echo "Git helpers loaded!"
fi
```

### Environment Variables

Modules can export settings as environment variables:

```toml
[settings]
editor = "nvim"
pager = "less -R"
theme = "dark"
```

These become available as:
- `$ZSH_MODULE_MYMODULE_EDITOR`
- `$ZSH_MODULE_MYMODULE_PAGER`
- `$ZSH_MODULE_MYMODULE_THEME`

### Hooks

Use hooks for setup and cleanup:

```toml
[hooks]
pre_load = "setup_git_config"
post_load = "register_completions"
```

**In your shell file:**
```bash
setup_git_config() {
    # Run before module files are sourced
    git config --global core.editor "$ZSH_MODULE_GIT_EDITOR"
}

register_completions() {
    # Run after module files are sourced
    compdef _git gc=git-commit
}
```

## Configuration Reference

### Module Directory

By default, Zephyr looks for modules in `$HOME/.zsh/modules`. You can override this:

```bash
export ZSH_MODULES_DIR="/path/to/my/modules"
```

### Priority System

Modules load in priority order (lower numbers first):

- `1-10`: Core system modules
- `11-50`: Framework and utility modules  
- `51-100`: Application-specific modules
- `101+`: User customizations

### Platform Filtering

Restrict modules to specific platforms:

```toml
[platforms]
os = ["darwin"]              # macOS only
arch = ["x86_64", "arm64"]   # Intel and Apple Silicon
shell = "zsh"                # ZSH only
min_version = "5.8"          # Minimum ZSH version
```

## Examples

### Example 1: Development Environment Module

```toml
# modules/dev-env/module.toml
[module]
name = "dev-env"
version = "1.0.0"
description = "Development environment setup"

[dependencies]
required = ["core"]

[load]
priority = 30
files = ["exports.zsh", "aliases.zsh", "functions.zsh"]

[settings]
editor = "code"
browser = "firefox"
```

```bash
# modules/dev-env/exports.zsh
export EDITOR="$ZSH_MODULE_DEV_ENV_EDITOR"
export BROWSER="$ZSH_MODULE_DEV_ENV_BROWSER"
export PATH="$HOME/.local/bin:$PATH"
```

```bash
# modules/dev-env/aliases.zsh
alias e='$EDITOR'
alias b='$BROWSER'
alias serve='python -m http.server 8000'
```

### Example 2: Git Workflow Module

```toml
# modules/git-flow/module.toml
[module]
name = "git-flow"
version = "2.1.0"
description = "Git workflow helpers"

[dependencies]
required = ["core"]
optional = ["colors"]

[load]
priority = 60
files = ["git-aliases.zsh", "git-functions.zsh"]

[hooks]
post_load = "setup_git_completion"

[settings]
default_branch = "main"
push_default = "simple"
```

```bash
# modules/git-flow/git-functions.zsh
# Create feature branch
gf() {
    local branch_name="feature/$1"
    git checkout -b "$branch_name"
    git push -u origin "$branch_name"
}

# Quick commit and push
gcp() {
    git add .
    git commit -m "$1"
    git push
}

setup_git_completion() {
    # Set up custom completions
    compdef gf=git-checkout
    compdef gcp=git-commit
}
```

### Example 3: macOS-Specific Module

```toml
# modules/macos-utils/module.toml
[module]
name = "macos-utils"
version = "1.0.0"
description = "macOS-specific utilities"

[platforms]
os = ["darwin"]

[load]
priority = 80
files = ["macos-aliases.zsh"]
```

```bash
# modules/macos-utils/macos-aliases.zsh
# macOS specific aliases
alias showfiles='defaults write com.apple.finder AppleShowAllFiles YES; killall Finder'
alias hidefiles='defaults write com.apple.finder AppleShowAllFiles NO; killall Finder'
alias flushdns='sudo dscacheutil -flushcache'

# Homebrew shortcuts
alias brewup='brew update && brew upgrade'
alias brewclean='brew cleanup && brew doctor'
```

## Troubleshooting

See the [Troubleshooting Guide](docs/TROUBLESHOOTING.md) for common issues and solutions.

## Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## License

MIT License - see [LICENSE](LICENSE) file for details.

## Acknowledgments

- Built with [Odin](https://odin-lang.org/) programming language
- Inspired by modern package managers and module systems
- Thanks to the ZSH community for inspiration
